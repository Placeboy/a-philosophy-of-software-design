# 17.2 确保一致性

一致性是很难保持的，特别是当许多人在一个项目上工作了很长时间的时候。一个小组的人可能不知道另一个小组建立的惯例。新来的人不知道规则，所以他们无意中违反了惯例，并创造了与现有惯例冲突的新惯例。这里有一些建立和保持一致性的提示。

文件。创建一个文件，列出最重要的整体约定，如编码风格指南。把文件放在开发者可能看到的地方，比如项目Wiki上的一个显眼的地方。鼓励新加入小组的人阅读该文件，并鼓励现有的人每隔一段时间审查一次。一些来自不同组织的风格指南已经在网上发布；考虑从其中一个开始。

对于那些比较本地化的约定，例如不变式，在代码中找到一个合适的位置来记录它们。如果你不把这些约定写下来，其他人就不可能遵守它们。

强制执行。即使有好的文档，开发人员也很难记住所有的约定。强制执行约定的最好方法是编写一个工具来检查违规行为，并确保代码在通过检查器之前不能被提交到版本库。自动检查器对于低级别的语法约定来说效果特别好。

我最近的一个项目遇到了行终止符的问题。一些开发者在Unix系统上工作，那里的行是由换行符结束的；另一些开发者在Windows系统上工作，那里的行通常是由一个回车符和一个换行符结束的。如果一个系统的开发者对以前在另一个系统上编辑的文件做了一个小的编辑，编辑器有时会把所有的行结束符替换成适合该系统的结束符。这让人觉得文件的每一行都被修改了，这让人很难追踪有意义的变化。我们建立了一个惯例，即文件应该只包含换行符，但很难保证每个开发者使用的每一个工具都遵循这个惯例。每次有新的开发者加入项目，我们都会遇到大量的行终止问题，而该开发者也会适应这一惯例。

我们最终通过编写一个简短的脚本解决了这个问题，该脚本在修改提交到源代码库之前自动执行。该脚本检查所有被修改的文件，如果有任何文件包含回车，就中止提交。该脚本也可以手动运行，通过用换行符替换回车/换行符序列来修复损坏的文件。这一下子就消除了问题，而且还有助于培训新的开发人员。

代码审查提供了另一个执行惯例和教育新开发者的机会。代码审查员越是吹毛求疵，团队中的每个人就会越快地学会这些惯例，代码也会越干净。

当在罗马时... 最重要的约定是，每个开发者都应该遵循古老的格言 "当在罗马时，像罗马人那样做"。当在一个新文件中工作时，看看周围的现有代码是如何结构的。所有的公共变量和方法都是在私有变量和方法之前声明的吗？这些方法是按字母顺序排列的吗？变量是使用 "驼峰大小写"，如firstServerName，还是使用 "蛇形大小写"，如first\_server\_name？当你看到任何看起来有可能是约定俗成的东西时，请遵循它。当做出一个设计决定时，问问自己是否有可能在项目的其他地方做出过类似的决定；如果是的话，找到一个现有的例子，在你的新代码中使用同样的方法。

不要改变现有的惯例。抵制 "改进 "现有惯例的冲动 不要改变现有惯例。抵制 "改进 "现有惯例的冲动。有一个 "更好的想法 "并不是引入不一致的充分借口。你的新想法可能确实更好，但一致性比不一致性的价值几乎总是比一种方法的价值大。在引入不一致的行为之前，问自己两个问题。首先，你是否有重要的新信息来证明你的方法是正确的，而这些信息在旧的惯例建立时是没有的？第二，新的方法是否好得多，值得花时间去更新所有旧的用法？如果你的组织同意这两个问题的答案都是 "是"，那么就去做升级；当你完成后，旧的惯例应该没有任何痕迹了。然而，你仍然面临着其他开发者不知道新惯例的风险，所以他们可能在将来重新采用旧的方法。总的来说，重新考虑既定的惯例很少是对开发者时间的良好利用。&#x20;
